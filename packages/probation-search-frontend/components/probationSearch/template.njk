{% from "govuk/components/input/macro.njk" import govukInput %}
{% from "govuk/components/button/macro.njk" import govukButton %}
{% from "govuk/components/pagination/macro.njk" import govukPagination %}
{% from "govuk/components/table/macro.njk" import govukTable %}

<form id="{{ params.id }}-form" method="POST">
    <input type="hidden" name="_csrf" value="{{ params.results.csrfToken }}">

    <div id="{{ params.id }}-input-container">
        {{ govukInput({
            attributes: params.attributes,
            autocomplete: params.autocomplete,
            classes: params.classes,
            errorMessage: params.results.errorMessage,
            hint: params.hint if params.hint else {
                text: "Search using identifiers, names, aliases, date of birth..."
            },
            id: params.id,
            label: params.label if params.label else {
                text: "Search for a person on probation",
                classes: "govuk-label--l",
                isPageHeading: true
            },
            name: params.name,
            type: params.type if params.type else "search",
            value: params.results.query
        }) }}

        {% if params.results.suggestions | length %}
            <p id="{{ params.id }}-suggestions">
                Did you mean
                {%- set comma = joiner() %}
                {%- for suggestion in params.results.suggestions %}{{ comma() }}
                    <a href="?q={{ suggestion }}" class="govuk-link govuk-link--no-visited-state"
                       title="Search again using {{ suggestion }}">{{ suggestion }}</a>
                {%- endfor %}?
            </p>
        {% endif %}

        {% if params.postHint %}
            {{ params.postHint.html | safe if params.postHint.html else '<p>' + params.postHint.text + '</p>' }}
        {% endif %}

        {% if params.searchOnInput %}
            <label for="{{ params.id }}" class="govuk-visually-hidden">Results will be updated as you type</label>
            <script nonce="{{ params.results.cspNonce }}">
              let timeoutId = null;
              document.getElementById("{{ params.id }}").addEventListener("input", function() {
                window.clearTimeout(timeoutId);
                timeoutId = window.setTimeout(function() { document.getElementById("{{ params.id }}-form").submit() }, 250);
              })
            </script>
        {% else %}
            {{ govukButton({ text: "Search" }) }}
        {% endif %}
    </div>
</form>

{% if params.results.response.totalElements > 0 %}
    <div id="{{ params.id }}-results">
        <p>Showing {{ params.results.page.from }} to {{ params.results.page.to }} of {{ params.results.page.totalResults }} results.</p>

        {% if params.results.results is string %}
            {{ params.results.results | safe }}
        {% else %}
            {{ govukTable({ firstCellIsHeader: true, head: params.results.results.head, rows: params.results.results.rows }) }}
        {% endif %}

        {% if params.results.page.items | length > 1 %}
            {{ govukPagination({ previous: { href: params.results.page.prev }, next: { href: params.results.page.next }, items: params.results.page.items }) }}
        {% endif %}
    </div>
{% elif params.results.query != null %}
    <div id="{{ params.id }}-results"><p>There are no results for your search. Try refining your query above.</p></div>
{% endif %}