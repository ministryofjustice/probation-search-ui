{% from "govuk/components/input/macro.njk" import govukInput %}
{% from "govuk/components/button/macro.njk" import govukButton %}

<form id="{{ params.id }}-form" class="probation-search__form" method="POST">
    <input type="hidden" name="_csrf" value="{{ params.results.csrfToken }}">

    <div class="probation-search__input-container">
        {{ govukInput({
            attributes: params.attributes,
            autocomplete: params.autocomplete,
            classes: params.classes,
            errorMessage: params.results.errorMessage,
            hint: params.hint if params.hint else {
                text: "Search using identifiers, names, aliases, date of birth..."
            },
            id: params.id,
            label: params.label if params.label else {
                text: "Search for a person on probation",
                classes: "govuk-label--l",
                isPageHeading: true
            },
            name: "probation-search-input",
            type: params.type if params.type else "search",
            value: params.results.query
        }) }}

        <p id="{{ params.id }}-suggestions" class="probation-search__suggestions">
            {% if params.results.suggestions | length %}
                Did you mean
                {%- set comma = joiner() %}
                {%- for suggestion in params.results.suggestions %}{{ comma() }}
                    <a href="{{ suggestion.url }}" class="govuk-link govuk-link--no-visited-state"
                       title="Search again using {{ suggestion.text }}">{{ suggestion.text }}</a>
                {%- endfor %}?
            {% endif %}
        </p>

        {% if params.postHint %}
            {{ params.postHint.html | safe if params.postHint.html else '<p>' + params.postHint.text + '</p>' }}
        {% endif %}

        {% if params.searchOnInput %}
            <label for="{{ params.id }}" class="govuk-visually-hidden">Results will be updated as you type</label>
            <script nonce="{{ params.results.cspNonce }}">
              (() => {
                let timeoutId = null;

                function doSearch() {
                  clearTimeout(timeoutId);
                  const url = new URL(location.href);
                  url.searchParams.delete("page");
                  url.searchParams.delete("providers[]");
                  url.searchParams.set("q", document.getElementById("{{ params.id }}").value);
                  timeoutId = setTimeout(() => fetch(url).then(async response => {
                    if (response.status === 200) {
                      const doc = new DOMParser().parseFromString(await response.text(), "text/html");
                      document.getElementById("{{ params.id }}-results-container").innerHTML = doc.getElementById("{{ params.id }}-results-container").innerHTML;
                      document.getElementById("{{ params.id }}-results-container").classList = doc.getElementById("{{ params.id }}-results-container").classList;
                      document.getElementById("{{ params.id }}-suggestions").innerHTML = doc.getElementById("{{ params.id }}-suggestions").innerHTML;
                      document.getElementsByName("_csrf")[0].value = doc.getElementsByName("_csrf")[0].value;
                      history.pushState({}, "", url);
                    } else {
                      document.getElementById("{{ params.id }}-results-container").innerHTML = "<div class=\"govuk-error-summary\"><h2 class=\"govuk-error-summary__title\">Something went wrong</h2><div class=\"govuk-error-summary__body\">The error has been logged. Please try again.</div></div>";
                      document.getElementById("{{ params.id }}-suggestions").innerHTML = "";
                    }
                  }), 250);
                }

                document.getElementById("{{ params.id }}").addEventListener("input", doSearch);
                document.getElementById("{{ params.id }}-form").addEventListener("submit", e => {
                  doSearch();
                  e.preventDefault();
                });
              })();
            </script>
        {% else %}
            {{ govukButton({ text: "Search" }) }}
        {% endif %}
    </div>
</form>

<div id="{{ params.id }}-results-container"
     class="probation-search__results-container {{ 'probation-search__has-results' if params.results.results else '' }}">
{% include "./results.njk" %}
</div>